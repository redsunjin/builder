import json
import os

class GenerationAgent:
    """
    ìƒì„±/ê´€ë¦¬ ì—ì´ì „íŠ¸: 
    1) ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìˆëŠ” ì»´í¬ë„ŒíŠ¸ëŠ” ì¦‰ì‹œ ë°˜í™˜ (ìºì‹±/ì‚¬ì „ ì •ì˜)
    2) ì—†ëŠ” ì»´í¬ë„ŒíŠ¸ëŠ” LLMì„ í†µí•´ ìµœì†Œ ë‹¨ìœ„(Atomic)ë¡œ ë™ì  ìƒì„± í›„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì €ì¥.
    """
    def __init__(self):
        self.name = "GenerationAgent"
        # ì ˆëŒ€ ê²½ë¡œ ì²˜ë¦¬ (orchestrator ì‹¤í–‰ ê¸°ì¤€)
        base_dir = os.path.dirname(os.path.abspath(__file__))
        self.library_path = os.path.join(base_dir, "library", "components")

        # MVP í…ŒìŠ¤íŠ¸ìš© í•˜ë“œì½”ë”©ëœ ëª¨ì˜ LLM ì‘ë‹µê¸°
        self._mock_llm_responses = {
            "text_input": {
                "type": "component",
                "name": "text_input",
                "html_template": "<input type=\"text\" class=\"border p-2 rounded w-full\" placeholder=\"{placeholder}\" />",
                "required_params": ["placeholder"],
                "description": "A dynamic text input generated by LLM."
            },
            "custom_graph": {
                "type": "component",
                "name": "custom_graph",
                "html_template": "<div class=\"w-full h-32 bg-gray-200 border-2 border-dashed border-gray-400 flex items-center justify-center\"><span class=\"text-gray-500\">Dynamic Graph Area for {data_type}</span></div>",
                "required_params": ["data_type"],
                "description": "A dynamically generated atomic graph placeholder."
            }
        }

    def load_component_metadata(self, component_name: str) -> dict:
        file_path = os.path.join(self.library_path, f"{component_name}.json")
        
        # 1. ë¼ì´ë¸ŒëŸ¬ë¦¬(ìºì‹œ) í™•ì¸ ë¡œì§
        if os.path.exists(file_path):
            print(f"[{self.name}] ğŸŸ¢ ë¼ì´ë¸ŒëŸ¬ë¦¬ íˆíŠ¸: '{component_name}' (ì‚¬ì „ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ)")
            with open(file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
                
        # 2. ë™ì  ìƒì„± (Atomic Component) ë¡œì§
        print(f"[{self.name}] ğŸŸ¡ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸ìŠ¤: '{component_name}' (LLM ìµœì†Œ ë‹¨ìœ„ ë™ì  ìƒì„± ì‹œì‘)")
        
        # ì‹¤ì œë¡œëŠ” ì´ê³³ì—ì„œ OpenAI API ë“±ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
        # [PROMPT] "UI ì»´í¬ë„ŒíŠ¸ ì´ë¦„ '{component_name}'ì— ëŒ€í•œ ìµœì†Œ ë‹¨ìœ„ì˜ HTML(Tailwind) ì½”ë“œì™€ ë©”íƒ€ë°ì´í„° JSON í¬ë§·ì„ ë§Œë“¤ì–´ì¤˜."
        dynamic_component = self._call_llm_for_atomic_component(component_name)
        
        # 3. ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì €ì¥ (ìºì‹±)
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(dynamic_component, f, indent=4, ensure_ascii=False)
        print(f"[{self.name}] ğŸ’¾ ë™ì  ì»´í¬ë„ŒíŠ¸ ì €ì¥ ì™„ë£Œ: '{component_name}'")
        
        return dynamic_component

    def _call_llm_for_atomic_component(self, name: str) -> dict:
        """LLM í˜¸ì¶œì„ ëª¨ë°©í•˜ëŠ” í•¨ìˆ˜ (MVP ìš©)"""
        if name in self._mock_llm_responses:
            return self._mock_llm_responses[name]
        
        # Fallback (ì „í˜€ ëª¨ë¥´ëŠ” ì»´í¬ë„ŒíŠ¸ì¼ ê²½ìš°)
        return {
            "type": "component",
            "name": name,
            "html_template": f"<div class=\"p-4 bg-yellow-100 border border-yellow-300\">Generated: {name} ({'{'}param{'}'})</div>",
            "required_params": ["param"],
            "description": f"Fallback LLM generated component for {name}."
        }
